<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Education - Video Clips</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f0f4f8;
            color: #334155;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .video-container {
            position: relative;
            width: 100%;
            margin-bottom: 2rem;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        #clipPlayer {
            width: 100%;
            display: block;
            min-height: 400px;
            background-color: #1a1a1a;
        }

        .chapter {
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chapter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background-color: #f8fafc;
        }

        .chapter.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .play-button {
            background-color: #1e40af;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            cursor: pointer;
        }

        .chapter-title {
            font-size: 1.25rem;
            color: #1e40af;
            margin: 0;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            text-align: center;
        }

        .loading-indicator.visible {
            display: block;
        }

        .error-message {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fee2e2;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .status-badge {
            background-color: #f1f5f9;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            color: #64748b;
        }

        .chapter-content {
            margin-top: 1rem;
            color: #64748b;
        }

        .debug-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.875rem;
            display: none;
        }

        @media (max-width: 640px) {
            .chapter-header {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dental Education Video Clips</h1>
        <div class="video-container">
            <video id="clipPlayer" controls>
                Your browser does not support the video tag.
            </video>
            <div id="loadingIndicator" class="loading-indicator">
                <div>Generating clip...</div>
                <div id="loadingStatus" style="font-size: 0.875rem; margin-top: 0.5rem"></div>
            </div>
            <div id="errorMessage" class="error-message"></div>
            <div id="debugInfo" class="debug-info"></div>
        </div>
        <div id="chapters"></div>
    </div>

    <script>
        const API_KEY = 'tlk_2FT1AC42M8MJND2SQPCN51JAJ3HS';
        const VIDEO_ID = '672a368d1a5f2afde1137103'; // Updated video ID
        const BASE_URL = 'https://api.twelvelabs.io/v1.2';

        const chapters = {
            "id": "544e6f36-01ff-4884-a7cd-b9d7c04da73c",
            "chapters": [
                {
                    "chapter_number": 0,
                    "start": 0,
                    "end": 180,
                    "chapter_title": "Introduction to Dental Health and Orthodontic Intrusion",
                    "chapter_summary": "The video begins with Dr. Tyler Rathburn discussing the importance of dental health and orthodontic intrusion. He explains the concept of intrusion, its challenges, and its significance in restorative dental practices. The chapter includes detailed explanations of dental procedures, patient cases, and the biological aspects of tooth movement."
                },
                {
                    "chapter_number": 1,
                    "start": 180,
                    "end": 360,
                    "chapter_title": "Patient Cases and Treatment Sequencing",
                    "chapter_summary": "This chapter introduces patient cases, including John and Patrick, and discusses their dental issues and treatment plans. Dr. Rathburn explains the importance of treatment sequencing and the challenges faced in orthodontic and restorative treatments. The chapter highlights the use of technology and patient experiences to illustrate the benefits of proper dental care."
                },
                {
                    "chapter_number": 2,
                    "start": 360,
                    "end": 720,
                    "chapter_title": "Orthodontic Treatment Techniques and Challenges",
                    "chapter_summary": "The video delves into various orthodontic treatment techniques, including the use of braces and aligners. Dr. Rathburn discusses the challenges of different tooth movements, such as intrusion and torque, and compares the outcomes of using aligners versus fixed appliances. The chapter includes detailed patient case studies, highlighting the complexities and solutions in orthodontic treatments."
                },
                {
                    "chapter_number": 3,
                    "start": 720,
                    "end": 1424.7582581,
                    "chapter_title": "Comprehensive Dental Care and Interdisciplinary Planning",
                    "chapter_summary": "The final chapter emphasizes the importance of comprehensive dental care and interdisciplinary planning. Dr. Rathburn discusses the need for effective communication between dental specialists and patients, the challenges of treatment planning, and the benefits of combining orthodontic and restorative treatments. The video concludes with a call to action, encouraging viewers to seek professional dental care and consider the educational resources offered by Spear Education."
                }
            ]
        };

        async function fetchVideoClip(start, end) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingStatus = document.getElementById('loadingStatus');
            const errorMessage = document.getElementById('errorMessage');
            const debugInfo = document.getElementById('debugInfo');
            const clipPlayer = document.getElementById('clipPlayer');

            loadingIndicator.classList.add('visible');
            errorMessage.style.display = 'none';
            debugInfo.style.display = 'none';

            try {
                loadingStatus.textContent = 'Requesting clip generation...';
                
                // Create clip request
                const clipResponse = await fetch(`${BASE_URL}/clip`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'x-api-key': API_KEY
                    },
                    body: JSON.stringify({
                        video_id: VIDEO_ID,
                        start_time: start,
                        end_time: end
                    })
                });

                if (!clipResponse.ok) {
                    const errorData = await clipResponse.json();
                    debugInfo.textContent = `API Response: ${JSON.stringify(errorData, null, 2)}`;
                    debugInfo.style.display = 'block';
                    throw new Error(errorData.message || 'Failed to generate clip');
                }

                const clipData = await clipResponse.json();
                const clipId = clipData.clip_id;

                // Poll for clip status
                loadingStatus.textContent = 'Processing clip...';
                let attempts = 0;
                const maxAttempts = 30; // Maximum polling attempts

                while (attempts < maxAttempts) {
                    const statusResponse = await fetch(`${BASE_URL}/clip/${clipId}`, {
                        headers: {
                            'x-api-key': API_KEY
                        }
                    });
                    
                    if (!statusResponse.ok) {
                        const errorData = await statusResponse.json();
                        throw new Error(`Status check failed: ${errorData.message}`);
                    }

                    const statusData = await statusResponse.json();
                    
                    if (statusData.status === 'ready') {
                        loadingStatus.textContent = 'Loading video...';
                        clipPlayer.src = statusData.url;
                        await clipPlayer.play();
                        break;
                    } else if (statusData.status === 'failed') {
                        throw new Error('Clip generation failed');
                    }

                    attempts++;
                    loadingStatus.textContent = `Processing clip... (Attempt ${attempts}/${maxAttempts})`;
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

                if (attempts >= maxAttempts) {
                    throw new Error('Clip generation timed out');
                }

            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                loadingIndicator.classList.remove('visible');
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        const chaptersHTML = chapters.chapters.map(chapter => `
            <div class="chapter" onclick="fetchVideoClip(${chapter.start}, ${chapter.end})">
                <div class="chapter-header">
                    <h2 class="chapter-title">
                        <button class="play-button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </button>
                        ${chapter.chapter_title}
                    </h2>
                    <span class="status-badge">${formatTime(chapter.start)} - ${formatTime(chapter.end)}</span>
                </div>
                <p class="chapter-content">${chapter.chapter_summary}</p>
            </div>
        `).join('');

        document.getElementById('chapters').innerHTML = chaptersHTML;
    </script>
</body>
</html>
